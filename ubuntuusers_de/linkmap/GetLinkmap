#!/bin/bash
# GetLinkmap from ubuntuusers.de
# this file is part of InyokaEdit
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
# MA 02110-1301, USA.
#

echo "Downloading linkmap.csv ..."
rm linkmap.csv
wget -nv https://ubuntuusers.de/linkmap/export -O linkmap.csv

echo "Trying to get linkmap.css ..."
mapcss=$(wget -qO- https://ubuntuusers.de/ | grep -o '[0-9a-zA-Z._-]*/linkmap/linkmap-[0-9a-zA-Z]*\.css')
if [ "${mapcss}" == "" ]
  then
    echo "ERROR: Could not find linkmap.css"
    exit
fi

echo "Found linkmap.css: $mapcss"
rm linkmap.css
wget -nv https://$mapcss -O linkmap.css

if [ ! -d icons ]
  then
    echo "Creating folder \"icons\" ..."
    mkdir icons
fi
rm ./icons/*

cd icons
echo "Downloading images ..."
imgurls=($(grep -Eo '[0-9a-zA-Z._-]*/linkmap/icons/[0-9a-zA-Z_-]*\.(jpe?g|png|gif)' ../linkmap.css))
for i in "${imgurls[@]}"; do wget -nv "https://$i"; done

# "Special" IWLs / build-in features
wget -nv https://static-cdn.ubuntu-de.org/img/favicon.ico -O favicon.ico
wget -nv https://static-cdn.ubuntu-de.org/img/icons/small/ikhaya.png -O ikhaya.png
wget -nv https://static-cdn.ubuntu-de.org/img/interwiki/user.png -O user.png
cp user.png user-xmas.png

# Strip PNGs to prevent warning messages in log file generated by Qt/libpng (failed to parse ICC profile)
echo "Stripping PNGs ..."
for i in *.png; do convert -strip $i ./$i; done
cd ..

echo "Replace static paths..."
## Paths
_r1="//media-cdn.ubuntu-de.org/linkmap/"
_r2=""
## Escape path for sed using bash find and replace
_r1="${_r1//\//\\/}"
_r2="${_r2//\//\\/}"
## Replace paths
sed -e "s/${_r1}/${_r2}/g" -i linkmap.css

echo "LINKMAP DOWNLOAD FINISHED"
